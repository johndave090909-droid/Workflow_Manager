name: ðŸ“¸ Website Screenshot

on:
  # â”€â”€ Manual trigger from GitHub website â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow_dispatch:
    inputs:
      url:
        description: "Website URL to screenshot"
        required: true
        default: "https://nidl3r.github.io/PCC-KDS/"
      filename:
        description: "Output filename (without .png)"
        required: false
        default: "screenshot"

  # â”€â”€ Scheduled (optional) â€” runs every day at 9:00 AM UTC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Uncomment the two lines below to enable automatic daily screenshots:
  # schedule:
  #   - cron: "0 9 * * *"

jobs:
  screenshot:
    name: Take Screenshot
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the repo so screenshot.py is available
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install Chrome (latest stable)
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      # 4. Install dependencies
      - name: Install dependencies
        run: pip install selenium requests

      # 5. Take the screenshot
      - name: Take screenshot
        run: |
          URL="${{ github.event.inputs.url || 'https://nidl3r.github.io/PCC-KDS/' }}"
          FILENAME="${{ github.event.inputs.filename || 'screenshot' }}.png"
          echo "Screenshotting: $URL"
          python screenshot.py "$URL" "$FILENAME"

      # 6. Push to Firebase â€” screenshot appears on the site automatically
      - name: Push to Firebase
        env:
          SCREENSHOT_URL: ${{ github.event.inputs.url || 'https://nidl3r.github.io/PCC-KDS/' }}
          SCREENSHOT_FILENAME: ${{ github.event.inputs.filename || 'screenshot' }}.png
        run: |
          python3 - <<'PYEOF'
          import requests, os, sys, json, urllib.parse
          from datetime import datetime, timezone

          API_KEY  = "AIzaSyAgNSwj4LTeMbuVMTSbFRmbI6eKRYUsRXg"
          BUCKET   = "systems-hub.firebasestorage.app"
          URL      = os.environ["SCREENSHOT_URL"]
          FILENAME = os.environ["SCREENSHOT_FILENAME"]

          # â”€â”€ 1. Get anonymous Firebase ID token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          r = requests.post(
              f"https://identitytoolkit.googleapis.com/v1/accounts:signUp?key={API_KEY}",
              json={"returnSecureToken": True},
          )
          token = r.json().get("idToken")
          if not token:
              print(f"Auth failed: {r.text}")
              sys.exit(1)
          print("âœ“ Auth token obtained")

          # â”€â”€ 2. Upload PNG to Firebase Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          name      = f"screenshots/{FILENAME}"
          safe_name = urllib.parse.quote(name, safe="/")
          encoded   = urllib.parse.quote(name)

          with open(FILENAME, "rb") as f:
              img = f.read()

          r = requests.post(
              f"https://firebasestorage.googleapis.com/v0/b/{BUCKET}/o?name={safe_name}",
              data=img,
              headers={
                  "Content-Type": "image/png",
                  "Authorization": f"Bearer {token}",
              },
          )
          print(f"Storage ({r.status_code}): {r.text[:400]}")
          if r.status_code != 200:
              sys.exit(1)
          print("âœ“ Storage upload OK")

          # Extract the download token Firebase returns in the upload response
          upload_data = r.json()
          download_token = upload_data.get("downloadTokens", "")
          storage_url = (
              f"https://firebasestorage.googleapis.com/v0/b/{BUCKET}/o/{encoded}"
              f"?alt=media&token={download_token}"
          )

          # â”€â”€ 3. Write metadata to Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ts = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
          r = requests.post(
              f"https://firestore.googleapis.com/v1/projects/systems-hub/databases/(default)/documents/screenshots?key={API_KEY}",
              json={
                  "fields": {
                      "url":         {"stringValue": URL},
                      "storage_url": {"stringValue": storage_url},
                      "filename":    {"stringValue": FILENAME},
                      "captured_at": {"stringValue": ts},
                      "source":      {"stringValue": "github-actions"},
                  }
              },
              headers={"Authorization": f"Bearer {token}"},
          )
          print(f"Firestore ({r.status_code}): {r.text[:400]}")
          if r.status_code not in (200, 201):
              sys.exit(1)
          print("âœ“ Firestore write OK")
          print("âœ“ Synced â€” screenshot will appear on the site automatically")
          PYEOF

      # 7. Upload the PNG so you can download it from GitHub
      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        with:
          name: "screenshot-${{ github.run_number }}"
          path: "*.png"
          retention-days: 30        # file stays available for 30 days

      # 8. Print a summary in the Actions log
      - name: Summary
        run: |
          echo "### âœ… Screenshot complete" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ github.event.inputs.url || 'https://nidl3r.github.io/PCC-KDS/' }}" >> $GITHUB_STEP_SUMMARY
          echo "**File:** ${{ github.event.inputs.filename || 'screenshot' }}.png" >> $GITHUB_STEP_SUMMARY
          echo "Download from the **Artifacts** section below â¬‡ï¸" >> $GITHUB_STEP_SUMMARY
