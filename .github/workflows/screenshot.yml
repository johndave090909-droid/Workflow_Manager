name: ðŸ“¸ Website Screenshot

on:
  # â”€â”€ Manual trigger from GitHub website â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow_dispatch:
    inputs:
      url:
        description: "Website URL to screenshot"
        required: true
        default: "https://nidl3r.github.io/PCC-KDS/"
      filename:
        description: "Output filename (without .png)"
        required: false
        default: "screenshot"

  # â”€â”€ Scheduled (optional) â€” runs every day at 9:00 AM UTC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Uncomment the two lines below to enable automatic daily screenshots:
  # schedule:
  #   - cron: "0 9 * * *"

jobs:
  screenshot:
    name: Take Screenshot
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the repo so screenshot.py is available
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install Chrome (latest stable)
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      # 4. Install Selenium (auto-manages ChromeDriver)
      - name: Install dependencies
        run: pip install selenium

      # 5. Take the screenshot
      - name: Take screenshot
        run: |
          URL="${{ github.event.inputs.url || 'https://nidl3r.github.io/PCC-KDS/' }}"
          FILENAME="${{ github.event.inputs.filename || 'screenshot' }}.png"
          echo "Screenshotting: $URL"
          python screenshot.py "$URL" "$FILENAME"

      # 6. Push to Firebase â€” screenshot appears on the site automatically
      - name: Push to Firebase
        run: |
          URL="${{ github.event.inputs.url || 'https://nidl3r.github.io/PCC-KDS/' }}"
          FILENAME="${{ github.event.inputs.filename || 'screenshot' }}.png"
          API_KEY="AIzaSyAgNSwj4LTeMbuVMTSbFRmbI6eKRYUsRXg"

          # URL-encode the storage path for download URL (slashes â†’ %2F)
          ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('screenshots/$FILENAME'))")
          # Name for upload query param â€” keep slashes, but encode spaces/special chars
          NAME=$(python3 -c "import urllib.parse; print(urllib.parse.quote('screenshots/$FILENAME', safe='/'))")
          STORAGE_URL="https://firebasestorage.googleapis.com/v0/b/systems-hub.firebasestorage.app/o/${ENCODED}?alt=media"

          echo "Uploading to Firebase Storage..."
          STORAGE_STATUS=$(curl -s -o /tmp/storage_out.json -w "%{http_code}" -X POST \
            "https://firebasestorage.googleapis.com/v0/b/systems-hub.firebasestorage.app/o?name=${NAME}" \
            -H "Content-Type: image/png" \
            --data-binary @"$FILENAME")
          echo "Storage response (HTTP $STORAGE_STATUS):"
          cat /tmp/storage_out.json && echo ""
          if [ "$STORAGE_STATUS" != "200" ]; then
            echo "âŒ Storage upload failed" && exit 1
          fi
          echo "âœ“ Storage upload OK"

          echo ""
          echo "Writing metadata to Firestore..."
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          FIRESTORE_STATUS=$(curl -s -o /tmp/firestore_out.json -w "%{http_code}" -X POST \
            "https://firestore.googleapis.com/v1/projects/systems-hub/databases/(default)/documents/screenshots?key=${API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"fields\":{\"url\":{\"stringValue\":\"${URL}\"},\"storage_url\":{\"stringValue\":\"${STORAGE_URL}\"},\"filename\":{\"stringValue\":\"${FILENAME}\"},\"captured_at\":{\"stringValue\":\"${TIMESTAMP}\"},\"source\":{\"stringValue\":\"github-actions\"}}}")
          echo "Firestore response (HTTP $FIRESTORE_STATUS):"
          cat /tmp/firestore_out.json && echo ""
          if [ "$FIRESTORE_STATUS" != "200" ]; then
            echo "âŒ Firestore write failed" && exit 1
          fi
          echo "âœ“ Firestore write OK"
          echo "âœ“ Synced to Firebase â€” screenshot will appear on the site automatically"

      # 7. Upload the PNG so you can download it from GitHub
      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        with:
          name: "screenshot-${{ github.run_number }}"
          path: "*.png"
          retention-days: 30        # file stays available for 30 days

      # 8. Print a summary in the Actions log
      - name: Summary
        run: |
          echo "### âœ… Screenshot complete" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ github.event.inputs.url || 'https://nidl3r.github.io/PCC-KDS/' }}" >> $GITHUB_STEP_SUMMARY
          echo "**File:** ${{ github.event.inputs.filename || 'screenshot' }}.png" >> $GITHUB_STEP_SUMMARY
          echo "Download from the **Artifacts** section below â¬‡ï¸" >> $GITHUB_STEP_SUMMARY
