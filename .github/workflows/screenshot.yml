name: ðŸ“¸ Website Screenshot

on:
  # â”€â”€ Manual trigger from GitHub website â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow_dispatch:
    inputs:
      url:
        description: "Website URL to screenshot"
        required: true
        default: "https://nidl3r.github.io/PCC-KDS/"
      filename:
        description: "Output filename (without .png)"
        required: false
        default: "screenshot"
      selector:
        description: "CSS selector to capture a specific element (leave blank for full page)"
        required: false
        default: "#current-guest-counts"

  # â”€â”€ Daily schedule â€” 7:55 AM Hawaii time (HST = UTC-10, so 17:55 UTC) â”€â”€â”€â”€â”€â”€
  schedule:
    - cron: "36 7 * * *"

jobs:
  screenshot:
    name: Take Screenshot
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the repo so screenshot.py is available
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install Chrome (latest stable)
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      # 4. Install dependencies
      - name: Install dependencies
        run: pip install selenium requests

      # 5. Take the screenshot (unique timestamped filename per run)
      - name: Take screenshot
        run: |
          URL="${{ github.event.inputs.url || 'https://nidl3r.github.io/PCC-KDS/' }}"
          BASE="${{ github.event.inputs.filename || 'screenshot' }}"
          TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)
          FILENAME="${BASE}_${TIMESTAMP}.png"
          echo "SCREENSHOT_FILENAME=${FILENAME}" >> $GITHUB_ENV
          echo "SCREENSHOT_URL=${URL}" >> $GITHUB_ENV
          SELECTOR="${{ github.event.inputs.selector || '#current-guest-counts' }}"
          echo "Screenshotting: $URL â†’ $FILENAME (selector: '${SELECTOR}')"
          python screenshot.py "$URL" "$FILENAME" "$SELECTOR"

      # 6. Push to Firebase Storage + Firestore, export STORAGE_URL for next step
      - name: Push to Firebase
        run: |
          python3 - <<'PYEOF'
          import requests, os, sys, urllib.parse
          from datetime import datetime, timezone

          API_KEY  = "AIzaSyAgNSwj4LTeMbuVMTSbFRmbI6eKRYUsRXg"
          BUCKET   = "systems-hub.firebasestorage.app"
          URL      = os.environ["SCREENSHOT_URL"]
          FILENAME = os.environ["SCREENSHOT_FILENAME"]

          # â”€â”€ 1. Get anonymous Firebase ID token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          r = requests.post(
              f"https://identitytoolkit.googleapis.com/v1/accounts:signUp?key={API_KEY}",
              json={"returnSecureToken": True},
          )
          token = r.json().get("idToken")
          if not token:
              print(f"Auth failed: {r.text}")
              sys.exit(1)
          print("âœ“ Auth token obtained")

          # â”€â”€ 2. Upload PNG to Firebase Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          name      = f"screenshots/{FILENAME}"
          safe_name = urllib.parse.quote(name, safe="/")
          encoded   = urllib.parse.quote(name, safe="")

          with open(FILENAME, "rb") as f:
              img = f.read()

          r = requests.post(
              f"https://firebasestorage.googleapis.com/v0/b/{BUCKET}/o?name={safe_name}",
              data=img,
              headers={
                  "Content-Type": "image/png",
                  "Authorization": f"Bearer {token}",
              },
          )
          print(f"Storage ({r.status_code}): {r.text[:400]}")
          if r.status_code != 200:
              sys.exit(1)
          print("âœ“ Storage upload OK")

          upload_data   = r.json()
          download_token = upload_data.get("downloadTokens", "")
          storage_url = (
              f"https://firebasestorage.googleapis.com/v0/b/{BUCKET}/o/{encoded}"
              f"?alt=media&token={download_token}"
          )

          # â”€â”€ 3. Write metadata to Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ts = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
          r = requests.post(
              f"https://firestore.googleapis.com/v1/projects/systems-hub/databases/(default)/documents/screenshots?key={API_KEY}",
              json={
                  "fields": {
                      "url":         {"stringValue": URL},
                      "storage_url": {"stringValue": storage_url},
                      "filename":    {"stringValue": FILENAME},
                      "captured_at": {"stringValue": ts},
                      "source":      {"stringValue": "github-actions"},
                  }
              },
              headers={"Authorization": f"Bearer {token}"},
          )
          print(f"Firestore ({r.status_code}): {r.text[:400]}")
          if r.status_code not in (200, 201):
              sys.exit(1)
          print("âœ“ Firestore write OK")

          # â”€â”€ 4. Export storage URL so the Facebook step can use it â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"STORAGE_URL={storage_url}\n")
          print("âœ“ Synced â€” screenshot will appear on the site automatically")
          PYEOF

      # 7. Send Facebook Messenger notification with the screenshot
      - name: Send Facebook notification
        env:
          FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
          RECIPIENT_ID:  ${{ secrets.RECIPIENT_ID }}
        run: |
          python3 - <<'PYEOF'
          import requests, os, sys

          PAGE_TOKEN   = os.environ.get("FB_PAGE_TOKEN", "")
          RECIPIENT_ID = os.environ.get("RECIPIENT_ID", "")
          STORAGE_URL  = os.environ.get("STORAGE_URL", "")

          if not PAGE_TOKEN or not RECIPIENT_ID:
              print("âš  FB_PAGE_TOKEN or RECIPIENT_ID secret not configured â€” skipping")
              sys.exit(0)

          BASE = f"https://graph.facebook.com/v19.0/me/messages?access_token={PAGE_TOKEN}"

          # Send screenshot image attachment
          if STORAGE_URL:
              r = requests.post(BASE, json={
                  "recipient": {"id": RECIPIENT_ID},
                  "message": {
                      "attachment": {
                          "type": "image",
                          "payload": {"url": STORAGE_URL, "is_reusable": True},
                      }
                  },
              })
              d = r.json()
              if "error" in d:
                  print(f"âš  Image error: {d['error']['message']}")
              else:
                  print(f"âœ“ Image sent ({d.get('message_id')})")

          # Send caption text
          r = requests.post(BASE, json={
              "recipient": {"id": RECIPIENT_ID},
              "message":   {"text": "Daily screenshot report"},
          })
          d = r.json()
          if "error" in d:
              print(f"âš  Text error: {d['error']['message']}")
          else:
              print(f"âœ“ Message sent ({d.get('message_id')})")
          PYEOF

      # 8. Upload the PNG so you can download it from GitHub
      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: "screenshot-${{ github.run_number }}"
          path: "*.png"
          retention-days: 30

      # 9. Print a summary in the Actions log
      - name: Summary
        run: |
          echo "### âœ… Screenshot complete" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${SCREENSHOT_URL}" >> $GITHUB_STEP_SUMMARY
          echo "**File:** ${SCREENSHOT_FILENAME}" >> $GITHUB_STEP_SUMMARY
          echo "**Facebook:** notified âœ“" >> $GITHUB_STEP_SUMMARY
          echo "Download from the **Artifacts** section below â¬‡ï¸" >> $GITHUB_STEP_SUMMARY
